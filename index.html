<!doctype html>
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.7/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.7/js/modules/annotations.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.7/highcharts-more.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="regression.js"></script>
    <script src="papaparse.min.js"></script>
    <script src="helpers.js"></script>
    <style type="text/css">
        form header {
            font-weight: bold;
        }

        .figure {
            min-width: 500px;
            max-width: 800px;
            height: 340px;
        }
    </style>
</head>

<body>
    <form id="baseline">
        <header>Year range for baseline</header>
        <label for="baselineLower">Lower limit</label>
        <input name="baselineLower" type="text" value="1961">
        <br>
        <label for="baselineUpper">Upper limit</label>
        <input name="baselineUpper" type="text" value="1990">
        <br>
        <input type="submit">
    </form>

    <div id="AbiskoTemperatures" class="figure"></div>
    <div id="AbiskoTemperaturesSummer" class="figure"></div>
    <div id="AbiskoTemperaturesWinter" class="figure"></div>
    <div id="monthlyAbiskoTemperatures_jan" class="figure"></div>
    <div id="monthlyAbiskoTemperatures_feb" class="figure"></div>
    <div id="monthlyAbiskoTemperatures_mar" class="figure"></div>
    <div id="monthlyAbiskoTemperatures_apr" class="figure"></div>
    <div id="monthlyAbiskoTemperatures_may" class="figure"></div>
    <div id="monthlyAbiskoTemperatures_jun" class="figure"></div>
    <div id="monthlyAbiskoTemperatures_jul" class="figure"></div>
    <div id="monthlyAbiskoTemperatures_aug" class="figure"></div>
    <div id="monthlyAbiskoTemperatures_sep" class="figure"></div>
    <div id="monthlyAbiskoTemperatures_oct" class="figure"></div>
    <div id="monthlyAbiskoTemperatures_nov" class="figure"></div>
    <div id="monthlyAbiskoTemperatures_dec" class="figure"></div>

    <div id="northernHemisphere" class="figure"></div>
    <div id="globalTemperatures" class="figure"></div>

    <div id ="growingSeason" class="figure"></div>

    <div id="temperatureDifferenceAbisko" class="figure"></div>
    <div id="temperatureDifference1" class="figure"></div>
    <div id="temperatureDifference2" class="figure"></div>
    <div id="temperatureDifference3" class="figure"></div>

    <div id="yearlyPrecipitation" class="figure"></div>
    <div id="summerPrecipitation" class="figure"></div>
    <div id="winterPrecipitation" class="figure"></div>
    <div id="monthlyPrecipitation_jan" class="figure"></div>
    <div id="monthlyPrecipitation_feb" class="figure"></div>
    <div id="monthlyPrecipitation_mar" class="figure"></div>
    <div id="monthlyPrecipitation_apr" class="figure"></div>
    <div id="monthlyPrecipitation_may" class="figure"></div>
    <div id="monthlyPrecipitation_jun" class="figure"></div>
    <div id="monthlyPrecipitation_jul" class="figure"></div>
    <div id="monthlyPrecipitation_aug" class="figure"></div>
    <div id="monthlyPrecipitation_sep" class="figure"></div>
    <div id="monthlyPrecipitation_oct" class="figure"></div>
    <div id="monthlyPrecipitation_nov" class="figure"></div>
    <div id="monthlyPrecipitation_dec" class="figure"></div>

    <div id="yearlyPrecipitationDifference" class="figure"></div>
    <div id="summerPrecipitationDifference" class="figure"></div>
    <div id="winterPrecipitationDifference" class="figure"></div>

    <div id="lakeIce" class="figure"></div>

    <script type="text/javascript">
        $('#baseline').submit((e) => {
            e.preventDefault();
            var lower = +e.target[0].value;
            var upper = +e.target[1].value;
            if (!lower || !upper) {
                alert('Something went wrong!');
                return;
            } else if (lower < 1913) {
                alert("Lower limit must be above 1913!");
                return;
            } else if (lower >= upper) {
                alert("Lower limit cant be larger or equal to upper limit!");
                return;
            } else if (upper > 2017) {
                alert("Upper limit must be below 2017!");
                return;
            }

            baselineLower = lower;
            baselineUpper = upper;
            parseZonal();
            parseAbisko();
        });

        Highcharts.setOptions({
            credits: false,
        });

        var precipColor = '#550965';

        var snowColor = {
            color: '#CDD8F0',
            borderColor: '#5F7CB9',
            hover: '#eeeeff',
        };

        var rainColor = {
            color: '#1000FB',
            borderColor: '#5F7CB9',
            hover: '#3333ff',
        };

        /***************************************/
        /* DATA TRANSFORMATIONS AND STATISTICS */
        /***************************************/

        var parseGISSTEMP = function (result) {
            var fields = result.meta.fields;
            var temperatures = [];

            result.data.forEach((row) => {
                var year = {};

                fields.forEach(field => year[field.toLowerCase()] = validNumber(row[field]));

                var monthlyTemperatures = months().map(month => year[month]).filter(Number);

                year.min = min(monthlyTemperatures);
                year.max = max(monthlyTemperatures);
                year.count = monthlyTemperatures.length;

                if (year.count > 0) {
                    year.avg = mean(monthlyTemperatures);

                    year.variance = 0;

                    if (year.count > 1) {
                        year.variance = variance(monthlyTemperatures);
                    }

                    year.ci = confidenceInterval(year.avg, year.variance, year.count);

                    temperatures.push(year);
                }
            });
            temperatures = temperatures.slice(33);

            ['min', 'max', 'avg'].forEach((statistic) => {
                temperatures[statistic] = temperatures.map(temps => ({
                    x: temps.year,
                    y: temps[statistic],
                })).slice(10);
            });

            temperatures.movAvg = movingAverages(temperatures.map(temps => temps.avg), 10)
                .map((avg, index) => ({
                    x: temperatures[index].year,
                    y: avg,
                })).slice(10);

            temperatures.ci = temperatures.map(temps => ({
                x: temps.year,
                low: temps.ci.low,
                high: temps.ci.high,
            }));

            temperatures.ciMovAvg = temperatures.ci.map(each => ({ x: each.x }));

            ['low', 'high'].forEach((bound) => {
                movingAverages(temperatures.ci.map(each => each[bound]), 10)
                    .forEach((value, index) => temperatures.ciMovAvg[index][bound] = value);
            });

            temperatures.ci = temperatures.ci.slice(10);
            temperatures.ciMovAvg = temperatures.ciMovAvg.slice(10);

            return temperatures;
        };

        var parseGISSTEMPzonalMeans = function (result) {
            var fields = result.meta.fields;
            var temperatures = [];
            temperatures['sum64n-90n'] = 0;
            temperatures['sumnhem'] = 0;
            temperatures['sumglob'] = 0;
            var count = 0;

            result.data.forEach((row) => {
                var year = {};

                fields.forEach(field => year[field.toLowerCase()] = validNumber(row[field]));

                if (withinBaselinePeriod(year.year)) {
                    temperatures['sum64n-90n'] += year['64n-90n'];
                    temperatures['sumnhem'] += year['nhem'];
                    temperatures['sumglob'] += year['glob'];
                    count++;
                }
                if (year.year >= 1913) {
                    temperatures.push(year);
                }
            });

            temperatures['avg64n-90n'] = temperatures['sum64n-90n'] / count;
            temperatures['avgnhem'] = temperatures['sumnhem'] / count;
            temperatures['avgglob'] = temperatures['sumglob'] / count;

            var difference = region => temperatures.map(each => ({
                x: each.year,
                y: each[region] - temperatures['avg' + region],
            }));

            temperatures['64n-90n'] = difference('64n-90n');
            temperatures['nhem'] = difference('nhem');
            temperatures['glob'] = difference('glob');

            return temperatures;
        };

        var parseAbiskoCsv = function (result) {
            var rows = result.data;

            var fields = {
                time: result.meta.fields[0],
                avg: result.meta.fields[1],
                min: result.meta.fields[2],
                max: result.meta.fields[3],
                precip: result.meta.fields[4],
            };

            var data = {};

            rows.forEach((row) => {
                var date = parseDate(row[fields.time]);
                var avg = parseNumber(row[fields.avg]);
                var precip = parseNumber(row[fields.precip]);

                var year = data[date.year] = data[date.year] || {
                    sum: 0,
                    count: 0,
                    precip: 0,
                    precip_snow: 0,
                    precip_rain: 0,
                    data: [],
                    weeklyTemperatures: [],
                };
                if (avg) {
                    year.sum += avg;
                    year.count++;

                    var w = weekNumberFromObj(date);
                    var weekly = year.weeklyTemperatures[w] = year.weeklyTemperatures[w] || { sum: 0, count: 0 };
                    weekly.sum += avg;
                    weekly.count++;
                }
                if (precip) {
                    year.precip += precip;
                    if (avg < 0) {
                        year.precip_snow += precip;
                    } else {
                        year.precip_rain += precip;
                    }
                }
                year.data.push({
                    date, avg,
                    min: parseNumber(row[fields.min]),
                    max: parseNumber(row[fields.max]),
                    precip,
                    precip_snow: (avg < 0) ? precip : 0,
                    precip_rain: (avg >= 0) ? precip : 0,
                });
            });

            var temperatureBaseline = { sum: 0, count: 0 };
            var precipitationBaselineYearly = { sum: 0, count: 0 };
            var precipitationBaselineSummer = { sum: 0, count: 0 };
            var precipitationBaselineWinter = { sum: 0, count: 0 };

            var entries = () => Object.entries(data);
            var keys = () => Object.keys(data);
            var values = () => Object.values(data);

            entries().forEach((entry) => {
                var year = entry[1];
                year.avg = year.sum / (year.count || 1);

                if (withinBaselinePeriod(entry[0])) {
                    temperatureBaseline.sum += year.avg;
                    temperatureBaseline.count++;
                }

                year.weeklyTemperatures = year.weeklyTemperatures.map(t => t.sum / t.count);

                var isWeekAboveZero = year.weeklyTemperatures.map(t => t > 0);
                var longestPeriod = 0;

                isWeekAboveZero.reduce((period, aboveZero) => {
                    if (aboveZero) {
                        period++;
                        longestPeriod = Math.max(longestPeriod, period);
                        return period;
                    } else {
                        return 0;
                    }
                }, 0);

                year.growingSeason = longestPeriod;

                var monthlyTemperatures = [];
                var monthlyPrecipitation = [];
                var summerTemperatures = { sum: 0, count: 0 };
                var winterTemperatures = { sum: 0, count: 0 };
                var summerPrecipitation = { total: 0, rain: 0, snow: 0 };
                var winterPrecipitation = { total: 0, rain: 0, snow: 0 };

                year.data.forEach((each) => {
                    var month = +each.date.month;
                    var t = monthlyTemperatures[month - 1] = monthlyTemperatures[month - 1] || {
                        sum: 0, count: 0
                    };
                    var p = monthlyPrecipitation[month - 1] = monthlyPrecipitation[month - 1] || {
                        total: 0, rain: 0, snow: 0,
                    };
                    if (each.avg) {
                        if (isSummerMonthByIndex(month)) {
                            summerTemperatures.sum += each.avg;
                            summerTemperatures.count++;
                        } else if (isWinterMonthByIndex(month)) {
                            winterTemperatures.sum += each.avg;
                            winterTemperatures.count++;
                        }
                        t.sum += each.avg;
                        t.count++;
                    }
                    if (each.precip) {
                        if (isSummerMonthByIndex(month)) {
                            summerPrecipitation.total += each.precip;
                            summerPrecipitation.snow += each.precip_snow;
                            summerPrecipitation.rain += each.precip_rain;
                        } else if (isWinterMonthByIndex(month)) {
                            winterPrecipitation.total += each.precip;
                            winterPrecipitation.snow += each.precip_snow;
                            winterPrecipitation.rain += each.precip_rain;
                        }
                        p.total += each.precip;
                        p.snow += each.precip_snow;
                        p.rain += each.precip_rain;
                    }
                });

                year.monthlyTemperatures = monthlyTemperatures.map(month => month.sum / month.count);
                year.summerTemperature = summerTemperatures.sum / summerTemperatures.count;
                year.winterTemperature = winterTemperatures.sum / winterTemperatures.count;

                year.monthlyPrecipitation = monthlyPrecipitation;
                year.summerPrecipitation = summerPrecipitation;
                year.winterPrecipitation = winterPrecipitation;

                if (withinBaselinePeriod(entry[0])) {
                    precipitationBaselineSummer.sum += summerPrecipitation.total;
                    precipitationBaselineSummer.count++;
                    precipitationBaselineWinter.sum += winterPrecipitation.total;
                    precipitationBaselineWinter.count++;
                    precipitationBaselineYearly.sum += sum(monthlyPrecipitation.map(p => p.total));
                    precipitationBaselineYearly.count++;
                }

                year.max = max(year.monthlyTemperatures);
                year.min = min(year.monthlyTemperatures);

                year.variance = 0;
                year.ci = { low: -Infinity, high: Infinity };

                if (year.monthlyTemperatures.length > 1) {
                    year.variance = variance(year.monthlyTemperatures);
                    year.ci = confidenceInterval(year.avg, year.variance, year.monthlyTemperatures.length);
                }
            });

            var yearly = statistic => entries().map(each => ({
                x: +each[0],
                y: each[1][statistic],
            }));

            var monthlyPrecipByStat = (monthIndex, statistic) => entries().map(each => ({
                x: +each[0],
                y: each[1].monthlyPrecipitation[monthIndex][statistic],
            }));

            var monthlyTemp = monthIndex => entries().map(entry => ({
                x: +entry[0],
                y: entry[1].monthlyTemperatures[monthIndex],
            }));

            var movingAveragesHighCharts = values => movingAverages(values, 10).map((avg, index) => ({
                x: keys()[index],
                y: avg,
            })).slice(10);

            var years = keys().map(Number);
            var monthlyPrecipitation = {};
            var monthlyTemps = {};

            months().forEach((month, index) => {
                var p = monthlyPrecipitation[month] = monthlyPrecipitation[month] || {};
                p.years = years.slice(10);
                p.total = monthlyPrecipByStat(index, 'total');
                p.movAvg = movingAveragesHighCharts(p.total.map(each => each.y));
                p.linear = linearRegression(p.years, p.movAvg.map(each => each.y));
                p.total = p.total.slice(10);
                p.rain = monthlyPrecipByStat(index, 'rain').slice(10);
                p.snow = monthlyPrecipByStat(index, 'snow').slice(10);

                var t = monthlyTemps[month] = {};
                t.avg = monthlyTemp(index);
                t.movAvg = movingAveragesHighCharts(t.avg.map(each => each.y));
                t.avg = t.avg.slice(10);
            });

            var seasonal = season => entries().map(each => ({
                x: +each[0],
                y: each[1][season],
            }));
            var summerTemps = { avg: seasonal('summerTemperature') };
            var winterTemps = { avg: seasonal('winterTemperature') };
            summerTemps.movAvg = movingAveragesHighCharts(summerTemps.avg.map(each => each.y));
            winterTemps.movAvg = movingAveragesHighCharts(winterTemps.avg.map(each => each.y));
            summerTemps.avg = summerTemps.avg.slice(10);
            winterTemps.avg = winterTemps.avg.slice(10);

            var seasonalPrecipByStat = (season, statistic) => entries().map(each => ({
                x: +each[0],
                y: each[1][season][statistic],
            }));
            var seasonalPrecipitation = { summerPrecipitation: {}, winterPrecipitation: {} };
            [
                { season: 'summerPrecipitation', baseline: precipitationBaselineSummer },
                { season: 'winterPrecipitation', baseline: precipitationBaselineWinter }
            ].forEach((e) => {
                var p = seasonalPrecipitation[e.season];
                p.years = years.slice(10);
                p.total = seasonalPrecipByStat(e.season, 'total');
                p.snow = seasonalPrecipByStat(e.season, 'snow').slice(10);
                p.rain = seasonalPrecipByStat(e.season, 'rain').slice(10);
                p.movAvg = movingAveragesHighCharts(p.total.map(each => each.y));
                p.linear = linearRegression(p.years, p.movAvg.map(each => each.y));
                p.difference = p.total.map(each => ({
                    x: each.x,
                    y: each.y - (e.baseline.sum / e.baseline.count),
                }));
                p.total = p.total.slice(10);
            });

            var ci = entries().map((each) => ({
                x: +each[0],
                low: each[1].ci.low,
                high: each[1].ci.high,
            }));

            var ciMovAvg = ci.map(each => ({ x: each.x }));
            ['low', 'high'].forEach(bound =>
                movingAverages(ci.map(each => each[bound]), 10)
                    .forEach((value, index) => ciMovAvg[index][bound] = value));

            var precipMovAvg = movingAveragesHighCharts(values().map(each => each.precip));

            return {
                years,
                avg: yearly('avg').slice(10),
                min: yearly('min').slice(10),
                max: yearly('max').slice(10),
                movAvg: movingAveragesHighCharts(values().map(each => each.avg)),
                ci: ci.slice(10),
                ciMovAvg: ciMovAvg.slice(10),

                growingSeason: {
                    weeks: yearly('growingSeason').slice(10),
                    movAvg: movingAveragesHighCharts(yearly('growingSeason').map(each => each.y)),
                },

                monthlyTemps,
                summerTemps,
                winterTemps,

                difference: yearly('avg').map(each => ({
                    x: each.x,
                    y: each.y - (temperatureBaseline.sum / temperatureBaseline.count),
                })),

                yearlyPrecipitation: {
                    years: years.slice(10),
                    total: yearly('precip').slice(10),
                    snow: yearly('precip_snow').slice(10),
                    rain: yearly('precip_rain').slice(10),
                    movAvg: precipMovAvg,
                    linear: linearRegression(years.slice(10), precipMovAvg.map(each => each.y)),
                    difference: yearly('precip').map(each => ({
                        x: each.x,
                        y: each.y - (precipitationBaselineYearly.sum / precipitationBaselineYearly.count),
                    })),
                },
                monthlyPrecipitation,
                summerPrecipitation: seasonalPrecipitation.summerPrecipitation,
                winterPrecipitation: seasonalPrecipitation.winterPrecipitation,
            };
        };

        var parseAbiskoIceData = function (result) {
            var fields = result.meta.fields;
            var data = result.data.slice(0,100);
            //console.table(data)

            data.forEach((row) => {

            })
        };

        /*****************/
        /* RENDER GRAPHS */
        /*****************/

        var renderTemperatureGraph = function (temperatures, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line',
                    zoomType: 'xy',
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Temperature [°C]'
                    },
                    plotLines: [{
                        value: 0,
                        color: 'rgb(204, 214, 235)',
                        width: 2,
                    }],
                    max: 2,
                    min: -3,
                    tickInterval: 1,
                    lineWidth: 1,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' °C',
                    valueDecimals: 2,
                },
                series: [{
                    name: 'Max',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#ff0000',
                    data: temperatures.max,
                    visible: false,
                }, {
                    name: 'Min',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#0000ff',
                    data: temperatures.min,
                    visible: false,
                }, {
                    name: 'Yearly average',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#888888',
                    data: temperatures.avg,
                    visible: false,
                }, {
                    name: 'Confidence interval',
                    type: 'arearange',
                    color: '#888888',
                    data: temperatures.ci,
                    zIndex: 0,
                    fillOpacity: 0.3,
                    lineWidth: 0,
                    states: { hover: { lineWidthPlus: 0 } },
                    marker: { enabled: false },
                    visible: false,
                }, {
                    name: 'Moving average',
                    color: '#888888',
                    marker: { enabled: false },
                    data: temperatures.movAvg,
                }, {
                    name: 'Confidence interval',
                    type: 'arearange',
                    color: '#7777ff',
                    data: temperatures.ciMovAvg,
                    zIndex: 0,
                    fillOpacity: 0.3,
                    lineWidth: 0,
                    states: { hover: { lineWidthPlus: 0 } },
                    marker: { enabled: false },
                }],
            });
        };

        var renderAbiskoTemperatureGraph = function (temperatures, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line',
                    zoomType: 'xy',
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Temperature [°C]'
                    },
                    plotLines: [{
                        value: 0,
                        color: 'rgb(204, 214, 235)',
                        width: 2,
                    }],
                    //max: 2,
                    //min: -3,
                    tickInterval: 1,
                    lineWidth: 1,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' °C',
                    valueDecimals: 2,
                },
                series: [{
                    name: 'Max',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#ff0000',
                    data: temperatures.max,
                    visible: false,
                }, {
                    name: 'Min',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#0000ff',
                    data: temperatures.min,
                    visible: false,
                }, {
                    name: 'Yearly average',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#888888',
                    data: temperatures.avg,
                    visible: true,
                }, {
                    name: 'Confidence interval',
                    type: 'arearange',
                    color: '#888888',
                    data: temperatures.ci,
                    zIndex: 0,
                    fillOpacity: 0.3,
                    lineWidth: 0,
                    states: { hover: { lineWidthPlus: 0 } },
                    marker: { enabled: false },
                    visible: false,
                }, {
                    name: 'Moving average',
                    color: '#888888',
                    marker: { enabled: false },
                    data: temperatures.movAvg,
                }, {
                    name: 'Confidence interval',
                    type: 'arearange',
                    color: '#7777ff',
                    data: temperatures.ciMovAvg,
                    zIndex: 0,
                    fillOpacity: 0.3,
                    lineWidth: 0,
                    states: { hover: { lineWidthPlus: 0 } },
                    marker: { enabled: false },
                    visible: false,
                }],
            });
        };

        var renderAbiskoMonthlyTemperatureGraph = function (temperatures, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line',
                    zoomType: 'xy',
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Temperature [°C]'
                    },
                    plotLines: [{
                        value: 0,
                        color: 'rgb(204, 214, 235)',
                        width: 2,
                    }],
                    //max: 2,
                    //min: -3,
                    tickInterval: 1,
                    lineWidth: 1,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' °C',
                    valueDecimals: 2,
                },
                series: [{
                    name: 'Monthly average',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#888888',
                    data: temperatures.avg,
                    visible: true,
                }, {
                    name: 'Moving average',
                    color: '#888888',
                    marker: { enabled: false },
                    data: temperatures.movAvg,
                }],
            });
        };

        var renderTemperatureDifferenceGraph = function (temperatures, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'column'
                },
                title: {
                    text: title,
                },
                subtitle: {
                    //text: 'Difference between yearly average and average for 1961-1990',
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                    plotBands: [{
                        color: 'rgb(245, 245, 245)',
                        from: baselineLower,
                        to: baselineUpper,
                    }],
                },
                yAxis: {
                    title: {
                        text: 'Temperature [°C]'
                    },
                    lineWidth: 1,
                    min: -2,
                    max: 3,
                    tickInterval: 1,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' °C',
                    valueDecimals: 2,
                },
                legend: {
                    enabled: false,
                },
                annotations: [{
                    labelOptions: {
                        barkgroundColor: 'red',
                        verticalAlign: 'top',
                    },
                    labels: [{
                        point: {
                            xAxis: 0,
                            yAxis: 0,
                            x: baselineLower + (baselineUpper - baselineLower) / 2,
                            y: 2.4,
                        },
                        text: 'Baseline',
                    }],
                }],
                series: [{
                    name: 'Difference',
                    data: temperatures,
                    color: 'red',
                    negativeColor: 'blue',
                }],
            });
        };

        var renderGrowingSeasonGraph = function (season, id) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line',
                    zoomType: 'xy',
                },
                title: {
                    text: 'Growing season',
                },
                subtitle: {
                    text: 'The maximum consecutive weeks with average temperature above freezing.',
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Weeks'
                    },
                    plotLines: [{
                        value: 0,
                        color: 'rgb(204, 214, 235)',
                        width: 2,
                    }],
                    tickInterval: 1,
                    lineWidth: 1,
                },
                tooltip: {
                    shared: true,
                    valueDecimals: 0,
                },
                series: [{
                    name: 'Weeks',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#00aa00',
                    data: season.weeks,
                    visible: true,
                }, {
                    name: 'Moving average',
                    color: '#00aa00',
                    marker: { enabled: false },
                    data: season.movAvg,
                }],
            });
        }

        var renderPrecipitationDifferenceGraph = function (precipitation, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'column'
                },
                title: {
                    text: title,
                },
                subtitle: {
                    //text: 'Difference between yearly average and average for 1961-1990',
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                    plotBands: [{
                        color: 'rgb(245, 245, 245)',
                        from: baselineLower,
                        to: baselineUpper,
                    }],
                },
                yAxis: {
                    title: {
                        text: 'Precipitation [mm]'
                    },
                    lineWidth: 1,
                    //min: -2,
                    //max: 3,
                    tickInterval: 1,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' mm',
                    valueDecimals: 2,
                },
                legend: {
                    enabled: false,
                },
                annotations: [{
                    labelOptions: {
                        barkgroundColor: 'red',
                        verticalAlign: 'top',
                    },
                    labels: [{
                        point: {
                            xAxis: 0,
                            yAxis: 0,
                            x: baselineLower + (baselineUpper - baselineLower) / 2,
                            y: 100,
                        },
                        text: 'Baseline',
                    }],
                }],
                series: [{
                    name: 'Difference',
                    data: precipitation,
                    color: 'red',
                    negativeColor: 'blue',
                }],
            });
        };

        var renderYearlyPrecipitationGraph = function (precipitation, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line'
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Total precipitation [mm]'
                    },
                    lineWidth: 1,
                    floor: 0, // Precipitation can never be negative
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' mm',
                    valueDecimals: 0,
                    headerFormat: '<span style="font-size: 10px">{point.key}</span><br/>' +
                        '<span style="color: red">\u25CF</span> Linear regression: <b>' + precipitation.linear + '</b><br />' +
                        '<span style="color: white; visibility: hidden">\u25CF</span> Total precipitation: <b>{point.total:.0f} mm</b><br />',
                },
                series: [{
                    name: 'Precipitation from snow',
                    type: 'column',
                    stack: 'precip',
                    stacking: 'normal',
                    data: precipitation.snow,
                    color: snowColor.color,
                    borderColor: snowColor.borderColor,
                    states: {
                        hover: {
                            color: snowColor.hover,
                            animation: {
                                duration: 0,
                            },
                        },
                    },
                }, {
                    name: 'Precipitation from rain',
                    type: 'column',
                    stack: 'precip',
                    stacking: 'normal',
                    data: precipitation.rain,
                    color: rainColor.color,
                    borderColor: rainColor.borderColor,
                    states: {
                        hover: {
                            color: rainColor.hover,
                            animation: {
                                duration: 0,
                            },
                        },
                    },
                }, {
                    name: 'Average precipitation',
                    color: precipColor,
                    data: precipitation.movAvg,
                }, {
                    name: 'Linear regression',
                    marker: {
                        enabled: false, // Linear regression lines doesn't contain points
                    },
                    color: 'red',
                    states: {
                        hover: {
                            lineWidth: 0, // Do nothing on hover
                        },
                    },
                    enableMouseTracking: false, // No interactivity
                    data: [
                        { x: precipitation.years[0], y: precipitation.linear(precipitation.years[0]) },
                        { x: precipitation.years[precipitation.years.length - 1], y: precipitation.linear(precipitation.years[precipitation.years.length - 1]) }
                    ],
                }],
            });
        };

        var renderMonthlyPrecipitationGraph = function (precipitation, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line'
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Total precipitation [mm]'
                    },
                    lineWidth: 1,
                    max: 150,
                    floor: 0, // Precipitation can never be negative
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' mm',
                    valueDecimals: 0,
                    headerFormat: '<span style="font-size: 10px">{point.key}</span><br/>' +
                        //'<span style="color: red">\u25CF</span> Linear regression: <b>' + precipitation.linear + '</b><br />' +
                        '<span style="color: white; visibility: hidden">\u25CF</span> Total precipitation: <b>{point.total:.0f} mm</b><br />',
                },
                series: [{
                    name: 'Precipitation from snow',
                    type: 'column',
                    stack: 'precip',
                    stacking: 'normal',
                    data: precipitation.snow,
                    color: snowColor.color,
                    borderColor: snowColor.borderColor,
                    states: {
                        hover: {
                            color: snowColor.hover,
                            animation: {
                                duration: 0,
                            },
                        },
                    },
                }, {
                    name: 'Precipitation from rain',
                    type: 'column',
                    stack: 'precip',
                    stacking: 'normal',
                    data: precipitation.rain,
                    color: rainColor.color,
                    borderColor: rainColor.borderColor,
                    states: {
                        hover: {
                            color: rainColor.hover,
                            animation: {
                                duration: 0,
                            },
                        },
                    },
                }, {
                    name: 'Average precipitation',
                    color: precipColor,
                    data: precipitation.movAvg,
                }],
            });
        };

        var renderAbiskoIceGraph = function (ice, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line'
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: [{
                    title: {
                        text: 'Ice freeze / break up [date]',
                    },
                    lineWidth: 1,
                    floor: 0,
                    type: 'datetime',
                }, {
                    title: {
                        text: 'Ice free time [days]',
                    },
                    lineWidth: 1,
                    opposite: true,
                    floor: 0,
                }],
                tooltip: {
                    shared: true,
                    valueDecimals: 0,
                },
                series: [{
                    yAxis: 0,
                    name: 'Ice breaking',
                    color: '#ff0000',
                    //data: combine(years, movingAverages(precipitation.map(totalPrecipitation), 10)).slice(10), // Remove the first 10
                }, {
                    yAxis: 0,
                    name: 'Linear regression',
                    marker: {
                        enabled: false, // Linear regression lines doesn't contain points
                    },
                    color: 'red',
                    states: {
                        hover: {
                            lineWidth: 0, // Do nothing on hover
                        },
                    },
                    enableMouseTracking: false, // No interactivity
                    //data: [
                    //    { x: years[10], y: precipitationLinear(years[10]) },
                    //    { x: years[years.length - 1], y: precipitationLinear(years[years.length - 1]) }
                    //],
                }],
            });
        };

        /*****************************/
        /* LOADING DATA HAPPENS HERE */
        /*****************************/

        Papa.parse('/data/NH.Ts downloaded 21062018.csv', {
            header: true,
            delimiter: ',',
            download: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            comments: 'Station',
            complete: function (result) {
                var temperatures = parseGISSTEMP(result);
                renderTemperatureGraph(temperatures, 'northernHemisphere', 'Northern Hemisphere temperatures');
            },
        });

        Papa.parse('/data/GLB.Ts downloaded 21062018.csv', {
            header: true,
            delimiter: ',',
            download: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            comments: 'Station',
            complete: function (result) {
                var temperatures = parseGISSTEMP(result);
                renderTemperatureGraph(temperatures, 'globalTemperatures', 'Global temperatures');
            },
        });

        var parseZonal = function () {
            var cached;

            var complete = (result) => {
                if (cached) result = cached;
                else cached = result;
                var temperatures = parseGISSTEMPzonalMeans(result);
                renderTemperatureDifferenceGraph(temperatures['64n-90n'], 'temperatureDifference1', 'Temperature difference for Arctic (64N-90N)');
                renderTemperatureDifferenceGraph(temperatures['nhem'], 'temperatureDifference2', 'Temperature difference for Northern Hemisphere');
                renderTemperatureDifferenceGraph(temperatures['glob'], 'temperatureDifference3', 'Global temperature difference');
            }

            Papa.parse('/data/ZonAnn.Ts+dSST downloaded 21062018.csv', {
                header: true,
                delimiter: ',',
                download: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete,
            });

            return complete;
        };
        parseZonal();

        var parseAbisko = function () {
            var cached;

            var complete = (result) => {
                if (cached) result = cached;
                else cached = result;
                var data = parseAbiskoCsv(result);
                var summerRange = monthName(summerMonths[0]) + ' to ' + monthName(summerMonths[summerMonths.length - 1]);
                var winterRange = monthName(winterMonths[0]) + ' to ' + monthName(winterMonths[winterMonths.length - 1]);
                renderAbiskoTemperatureGraph(data, 'AbiskoTemperatures', 'Abisko temperatures');
                renderAbiskoMonthlyTemperatureGraph(data.summerTemps, 'AbiskoTemperaturesSummer', 'Abisko temperatures for ' + summerRange);
                renderAbiskoMonthlyTemperatureGraph(data.winterTemps, 'AbiskoTemperaturesWinter', 'Abisko temperatures for ' + winterRange);
                months().forEach(month =>
                    renderAbiskoMonthlyTemperatureGraph(data.monthlyTemps[month], 'monthlyAbiskoTemperatures_' + month, 'Abisko temperatures for ' + monthName(month)));
                renderTemperatureDifferenceGraph(data.difference, 'temperatureDifferenceAbisko', 'Temperature difference for Abisko');

                renderGrowingSeasonGraph(data.growingSeason, 'growingSeason');

                renderYearlyPrecipitationGraph(data.yearlyPrecipitation, 'yearlyPrecipitation', 'Yearly precipitation');
                renderYearlyPrecipitationGraph(data.summerPrecipitation, 'summerPrecipitation', 'Precipitation for ' + summerRange);
                renderYearlyPrecipitationGraph(data.winterPrecipitation, 'winterPrecipitation', 'Precipitation for ' + winterRange);
                months().forEach(month =>
                    renderMonthlyPrecipitationGraph(data.monthlyPrecipitation[month], 'monthlyPrecipitation_' + month, 'Precipitation for ' + monthName(month)));

                renderPrecipitationDifferenceGraph(data.yearlyPrecipitation.difference, 'yearlyPrecipitationDifference', 'Precipitation difference');
                renderPrecipitationDifferenceGraph(data.summerPrecipitation.difference, 'summerPrecipitationDifference', 'Precipitation difference ' + summerRange);
                renderPrecipitationDifferenceGraph(data.winterPrecipitation.difference, 'winterPrecipitationDifference', 'Precipitation difference ' + winterRange);
            }

            Papa.parse('/data/ANS_Temp_Prec_1913-2017.csv', {
                header: true,
                //delimiter: ';',
                download: true,
                skipEmptyLines: true,
                dynamicTyping: false,
                complete,
            });

            return complete;
        };
        parseAbisko();

        Papa.parse('/data/ANS_Torneträsk-data.csv', {
            header: true,
            download: true,
            skipEmptyLines: true,
            complete: (result) => {
                var data = parseAbiskoIceData(result);
                renderAbiskoIceGraph(data, 'lakeIce', 'Freeze up and break up of lake ice vs ice free time');
            },
        });
    </script>
</body>

</html>