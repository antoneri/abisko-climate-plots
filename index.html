<!doctype html>
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.7/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.7/js/modules/annotations.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.7/highcharts-more.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="regression.js"></script>
    <script src="papaparse.min.js"></script>
    <script src="helpers.js"></script>
    <style type="text/css">
        form header {
            font-weight: bold;
        }

        figure div {
            min-width: 700px;
            max-width: 800px;
            height: 340px;
            float: left;
        }

        figure figcaption {
            min-width: 150px;
            max-width: 200px;
            padding: 40px 0 0 40px;
            float: left;
        }

        figure {
            width: 100vw;
            clear: both;
        }
    </style>
</head>

<body>
    <form id="baseline">
        <header>Year range for baseline</header>
        <label for="baselineLower">Lower limit</label>
        <input name="baselineLower" type="text" value="1961">
        <br>
        <label for="baselineUpper">Upper limit</label>
        <input name="baselineUpper" type="text" value="1990">
        <br>
        <input type="submit">
    </form>

    <figure>
        <div id="AbiskoTemperatures"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="AbiskoTemperaturesSummer"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="AbiskoTemperaturesWinter"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyAbiskoTemperatures_jan"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyAbiskoTemperatures_feb"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyAbiskoTemperatures_mar"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyAbiskoTemperatures_apr"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyAbiskoTemperatures_may"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyAbiskoTemperatures_jun"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyAbiskoTemperatures_jul"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyAbiskoTemperatures_aug"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyAbiskoTemperatures_sep"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyAbiskoTemperatures_oct"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyAbiskoTemperatures_nov"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyAbiskoTemperatures_dec"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="northernHemisphere"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="globalTemperatures"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="growingSeason"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="temperatureDifferenceAbisko"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="temperatureDifference1"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="temperatureDifference2"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="temperatureDifference3"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="yearlyPrecipitation"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="summerPrecipitation"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="winterPrecipitation"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyPrecipitation_jan"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyPrecipitation_feb"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyPrecipitation_mar"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyPrecipitation_apr"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyPrecipitation_may"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyPrecipitation_jun"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyPrecipitation_jul"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyPrecipitation_aug"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyPrecipitation_sep"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyPrecipitation_oct"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyPrecipitation_nov"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="monthlyPrecipitation_dec"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="yearlyPrecipitationDifference"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="summerPrecipitationDifference"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="winterPrecipitationDifference"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="abiskoSnowDepthPeriodMeans"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="abiskoSnowDepthPeriodMeans2"></div>
        <figcaption></figcaption>
    </figure>
    <figure>
        <div id="abiskoLakeIce" style="height: 450px"></div>
        <figcaption></figcaption>
    </figure>

    <script type="text/javascript">
        $('#baseline').submit((e) => {
            e.preventDefault();
            var lower = +e.target[0].value;
            var upper = +e.target[1].value;
            if (!lower || !upper) {
                alert('Something went wrong!');
                return;
            } else if (lower < 1913) {
                alert("Lower limit must be above 1913!");
                return;
            } else if (lower >= upper) {
                alert("Lower limit cant be larger or equal to upper limit!");
                return;
            } else if (upper > 2017) {
                alert("Upper limit must be below 2017!");
                return;
            }

            baselineLower = lower;
            baselineUpper = upper;
            parseZonal();
            parseAbisko();
        });

        Highcharts.setOptions({
            credits: false,
        });

        var precipColor = '#550965';

        var snowColor = {
            color: '#CDD8F0',
            borderColor: '#5F7CB9',
            hover: '#eeeeff',
        };

        var rainColor = {
            color: '#1000FB',
            borderColor: '#5F7CB9',
            hover: '#3333ff',
        };

        var useWebWorker = true;

        /***************************************/
        /* DATA TRANSFORMATIONS AND STATISTICS */
        /***************************************/

        var parseGISSTEMP = function (result) {
            var fields = result.meta.fields;
            var temperatures = [];

            result.data.forEach((row) => {
                var year = {};

                fields.forEach(field => year[field.toLowerCase()] = validNumber(row[field]));

                var monthlyTemperatures = months().map(month => year[month]).filter(Number);

                year.min = min(monthlyTemperatures);
                year.max = max(monthlyTemperatures);
                year.count = monthlyTemperatures.length;

                if (year.count > 0) {
                    year.avg = mean(monthlyTemperatures);

                    year.variance = 0;

                    if (year.count > 1) {
                        year.variance = variance(monthlyTemperatures);
                    }

                    year.ci = confidenceInterval(year.avg, year.variance, year.count);

                    temperatures.push(year);
                }
            });
            temperatures = temperatures.slice(33);

            ['min', 'max', 'avg'].forEach((statistic) => {
                temperatures[statistic] = temperatures.map(temps => ({
                    x: temps.year,
                    y: temps[statistic],
                })).slice(10);
            });

            temperatures.movAvg = movingAverages(temperatures.map(temps => temps.avg), 10)
                .map((avg, index) => ({
                    x: temperatures[index].year,
                    y: avg,
                })).slice(10);

            temperatures.ci = temperatures.map(temps => ({
                x: temps.year,
                low: temps.ci.low,
                high: temps.ci.high,
            }));

            temperatures.ciMovAvg = temperatures.ci.map(each => ({ x: each.x }));

            ['low', 'high'].forEach((bound) => {
                movingAverages(temperatures.ci.map(each => each[bound]), 10)
                    .forEach((value, index) => temperatures.ciMovAvg[index][bound] = value);
            });

            temperatures.ci = temperatures.ci.slice(10);
            temperatures.ciMovAvg = temperatures.ciMovAvg.slice(10);

            return temperatures;
        };

        var parseGISSTEMPzonalMeans = function (result) {
            var fields = result.meta.fields;
            var temperatures = [];
            temperatures['sum64n-90n'] = 0;
            temperatures['sumnhem'] = 0;
            temperatures['sumglob'] = 0;
            var count = 0;

            result.data.forEach((row) => {
                var year = {};

                fields.forEach(field => year[field.toLowerCase()] = validNumber(row[field]));

                if (withinBaselinePeriod(year.year)) {
                    temperatures['sum64n-90n'] += year['64n-90n'];
                    temperatures['sumnhem'] += year['nhem'];
                    temperatures['sumglob'] += year['glob'];
                    count++;
                }
                if (year.year >= 1913) {
                    temperatures.push(year);
                }
            });

            temperatures['avg64n-90n'] = temperatures['sum64n-90n'] / count;
            temperatures['avgnhem'] = temperatures['sumnhem'] / count;
            temperatures['avgglob'] = temperatures['sumglob'] / count;

            var difference = region => temperatures.map(each => ({
                x: each.year,
                y: each[region] - temperatures['avg' + region],
            }));

            temperatures['64n-90n'] = difference('64n-90n');
            temperatures['nhem'] = difference('nhem');
            temperatures['glob'] = difference('glob');

            return temperatures;
        };

        var parseAbiskoCsv = function (result) {
            var rows = result.data;

            var fields = {
                time: result.meta.fields[0],
                avg: result.meta.fields[1],
                min: result.meta.fields[2],
                max: result.meta.fields[3],
                precip: result.meta.fields[4],
            };

            var data = {};

            rows.forEach((row) => {
                var date = parseDate(row[fields.time]);
                var avg = parseNumber(row[fields.avg]);
                var precip = parseNumber(row[fields.precip]);

                var year = data[date.year] = data[date.year] || {
                    sum: 0,
                    count: 0,
                    precip: 0,
                    precip_snow: 0,
                    precip_rain: 0,
                    data: [],
                    weeklyTemperatures: [],
                };
                if (avg) {
                    year.sum += avg;
                    year.count++;

                    var w = weekNumber(createDate(date));
                    var weekly = year.weeklyTemperatures[w] = year.weeklyTemperatures[w] || { sum: 0, count: 0 };
                    weekly.sum += avg;
                    weekly.count++;
                }
                if (precip) {
                    year.precip += precip;
                    if (avg < 0) {
                        year.precip_snow += precip;
                    } else {
                        year.precip_rain += precip;
                    }
                }
                year.data.push({
                    date, avg,
                    min: parseNumber(row[fields.min]),
                    max: parseNumber(row[fields.max]),
                    precip,
                    precip_snow: (avg < 0) ? precip : 0,
                    precip_rain: (avg >= 0) ? precip : 0,
                });
            });

            var temperatureBaseline = { sum: 0, count: 0 };
            var precipitationBaselineYearly = { sum: 0, count: 0 };
            var precipitationBaselineSummer = { sum: 0, count: 0 };
            var precipitationBaselineWinter = { sum: 0, count: 0 };

            var entries = () => Object.entries(data);
            var keys = () => Object.keys(data);
            var values = () => Object.values(data);

            entries().forEach((entry) => {
                var year = entry[1];
                year.avg = year.sum / (year.count || 1);

                if (withinBaselinePeriod(entry[0])) {
                    temperatureBaseline.sum += year.avg;
                    temperatureBaseline.count++;
                }

                year.weeklyTemperatures = year.weeklyTemperatures.map(t => t.sum / t.count);

                var isWeekAboveZero = year.weeklyTemperatures.map(t => t > 0);
                var longestPeriod = 0;

                isWeekAboveZero.reduce((period, aboveZero) => {
                    if (aboveZero) {
                        period++;
                        longestPeriod = Math.max(longestPeriod, period);
                        return period;
                    } else {
                        return 0;
                    }
                }, 0);

                year.growingSeason = longestPeriod;

                var monthlyTemperatures = [];
                var monthlyPrecipitation = [];
                var summerTemperatures = { sum: 0, count: 0, min: Infinity, max: -Infinity };
                var winterTemperatures = { sum: 0, count: 0, min: Infinity, max: -Infinity };
                var summerPrecipitation = { total: 0, rain: 0, snow: 0 };
                var winterPrecipitation = { total: 0, rain: 0, snow: 0 };

                year.data.forEach((each) => {
                    var month = +each.date.month;
                    var t = monthlyTemperatures[month - 1] = monthlyTemperatures[month - 1] || {
                        sum: 0, count: 0, min: Infinity, max: -Infinity,
                    };
                    var p = monthlyPrecipitation[month - 1] = monthlyPrecipitation[month - 1] || {
                        total: 0, rain: 0, snow: 0,
                    };
                    if (each.avg) {
                        if (isSummerMonthByIndex(month)) {
                            summerTemperatures.sum += each.avg;
                            summerTemperatures.count++;
                            summerTemperatures.min = Math.min(summerTemperatures.min, each.avg);
                            summerTemperatures.max = Math.max(summerTemperatures.max, each.avg);
                        } else if (isWinterMonthByIndex(month)) {
                            winterTemperatures.sum += each.avg;
                            winterTemperatures.count++;
                            winterTemperatures.min = Math.min(winterTemperatures.min, each.avg);
                            winterTemperatures.max = Math.max(winterTemperatures.max, each.avg);
                        }
                        t.sum += each.avg;
                        t.count++;
                        t.min = Math.min(t.min, each.avg);
                        t.max = Math.max(t.max, each.avg);
                    }
                    if (each.precip) {
                        if (isSummerMonthByIndex(month)) {
                            summerPrecipitation.total += each.precip;
                            summerPrecipitation.snow += each.precip_snow;
                            summerPrecipitation.rain += each.precip_rain;
                        } else if (isWinterMonthByIndex(month)) {
                            winterPrecipitation.total += each.precip;
                            winterPrecipitation.snow += each.precip_snow;
                            winterPrecipitation.rain += each.precip_rain;
                        }
                        p.total += each.precip;
                        p.snow += each.precip_snow;
                        p.rain += each.precip_rain;
                    }
                });

                year.monthlyTemperatures = monthlyTemperatures.map(month => ({
                    avg: month.sum / month.count,
                    min: month.min,
                    max: month.max,
                }));

                year.summerTemperature = {
                    avg: summerTemperatures.sum / summerTemperatures.count,
                    min: summerTemperatures.min,
                    max: summerTemperatures.max,
                };

                year.winterTemperature = {
                    avg: winterTemperatures.sum / winterTemperatures.count,
                    min: winterTemperatures.min,
                    max: winterTemperatures.max,
                };

                year.monthlyPrecipitation = monthlyPrecipitation;
                year.summerPrecipitation = summerPrecipitation;
                year.winterPrecipitation = winterPrecipitation;

                if (withinBaselinePeriod(entry[0])) {
                    precipitationBaselineSummer.sum += summerPrecipitation.total;
                    precipitationBaselineSummer.count++;
                    precipitationBaselineWinter.sum += winterPrecipitation.total;
                    precipitationBaselineWinter.count++;
                    precipitationBaselineYearly.sum += sum(monthlyPrecipitation.map(p => p.total));
                    precipitationBaselineYearly.count++;
                }

                year.max = max(year.monthlyTemperatures.map(m => m.avg));
                year.min = min(year.monthlyTemperatures.map(m => m.avg));

                year.variance = 0;
                year.ci = { low: -Infinity, high: Infinity };

                if (year.monthlyTemperatures.length > 1) {
                    year.variance = variance(year.monthlyTemperatures.map(m => m.avg));
                    year.ci = confidenceInterval(year.avg, year.variance, year.monthlyTemperatures.length);
                }
            });

            var yearly = statistic => entries().map(each => ({
                x: +each[0],
                y: each[1][statistic],
            }));

            var monthlyPrecipByStat = (monthIndex, statistic) => entries().map(each => ({
                x: +each[0],
                y: each[1].monthlyPrecipitation[monthIndex][statistic],
            }));

            var monthlyTempByStat = (monthIndex, statistic) => entries().map(entry => ({
                x: +entry[0],
                y: entry[1].monthlyTemperatures[monthIndex][statistic],
            }));

            var movingAveragesHighCharts = values => movingAverages(values, 10).map((avg, index) => ({
                x: keys()[index],
                y: avg,
            })).slice(10);

            var years = keys().map(Number);
            var monthlyPrecipitation = {};
            var monthlyTemps = {};

            months().forEach((month, index) => {
                var p = monthlyPrecipitation[month] = monthlyPrecipitation[month] || {};
                p.years = years.slice(10);
                p.total = monthlyPrecipByStat(index, 'total');
                p.movAvg = movingAveragesHighCharts(p.total.map(each => each.y));
                p.linear = linearRegression(p.years, p.movAvg.map(each => each.y));
                p.total = p.total.slice(10);
                p.rain = monthlyPrecipByStat(index, 'rain').slice(10);
                p.snow = monthlyPrecipByStat(index, 'snow').slice(10);

                var t = monthlyTemps[month] = {};
                t.avg = monthlyTempByStat(index, 'avg');
                t.min = monthlyTempByStat(index, 'min').slice(10);
                t.max = monthlyTempByStat(index, 'max').slice(10);
                t.movAvg = movingAveragesHighCharts(t.avg.map(each => each.y));
                t.avg = t.avg.slice(10);
            });

            var seasonal = (season, statistic) => entries().map(each => ({
                x: +each[0],
                y: each[1][season][statistic],
            }));
            var summerTemps = {
                avg: seasonal('summerTemperature', 'avg'),
                min: seasonal('summerTemperature', 'min').slice(10),
                max: seasonal('summerTemperature', 'max').slice(10),
            };
            var winterTemps = {
                avg: seasonal('winterTemperature', 'avg'),
                min: seasonal('winterTemperature', 'min').slice(10),
                max: seasonal('winterTemperature', 'max').slice(10),
            };
            summerTemps.movAvg = movingAveragesHighCharts(summerTemps.avg.map(each => each.y));
            winterTemps.movAvg = movingAveragesHighCharts(winterTemps.avg.map(each => each.y));
            summerTemps.avg = summerTemps.avg.slice(10);
            winterTemps.avg = winterTemps.avg.slice(10);

            var seasonalPrecipByStat = (season, statistic) => entries().map(each => ({
                x: +each[0],
                y: each[1][season][statistic],
            }));
            var seasonalPrecipitation = { summerPrecipitation: {}, winterPrecipitation: {} };
            [
                { season: 'summerPrecipitation', baseline: precipitationBaselineSummer },
                { season: 'winterPrecipitation', baseline: precipitationBaselineWinter }
            ].forEach((e) => {
                var p = seasonalPrecipitation[e.season];
                p.years = years.slice(10);
                p.total = seasonalPrecipByStat(e.season, 'total');
                p.snow = seasonalPrecipByStat(e.season, 'snow').slice(10);
                p.rain = seasonalPrecipByStat(e.season, 'rain').slice(10);
                p.movAvg = movingAveragesHighCharts(p.total.map(each => each.y));
                p.linear = linearRegression(p.years, p.movAvg.map(each => each.y));
                p.difference = p.total.map(each => ({
                    x: each.x,
                    y: each.y - (e.baseline.sum / e.baseline.count),
                }));
                p.total = p.total.slice(10);
            });

            var ci = entries().map((each) => ({
                x: +each[0],
                low: each[1].ci.low,
                high: each[1].ci.high,
            }));

            var ciMovAvg = ci.map(each => ({ x: each.x }));
            ['low', 'high'].forEach(bound =>
                movingAverages(ci.map(each => each[bound]), 10)
                    .forEach((value, index) => ciMovAvg[index][bound] = value));

            var precipMovAvg = movingAveragesHighCharts(values().map(each => each.precip));

            return {
                years,
                avg: yearly('avg').slice(10),
                min: yearly('min').slice(10),
                max: yearly('max').slice(10),
                movAvg: movingAveragesHighCharts(values().map(each => each.avg)),
                ci: ci.slice(10),
                ciMovAvg: ciMovAvg.slice(10),

                growingSeason: {
                    weeks: yearly('growingSeason').slice(10),
                    movAvg: movingAveragesHighCharts(yearly('growingSeason').map(each => each.y)),
                },

                monthlyTemps,
                summerTemps,
                winterTemps,

                difference: yearly('avg').map(each => ({
                    x: each.x,
                    y: each.y - (temperatureBaseline.sum / temperatureBaseline.count),
                })),

                yearlyPrecipitation: {
                    years: years.slice(10),
                    total: yearly('precip').slice(10),
                    snow: yearly('precip_snow').slice(10),
                    rain: yearly('precip_rain').slice(10),
                    movAvg: precipMovAvg,
                    linear: linearRegression(years.slice(10), precipMovAvg.map(each => each.y)),
                    difference: yearly('precip').map(each => ({
                        x: each.x,
                        y: each.y - (precipitationBaselineYearly.sum / precipitationBaselineYearly.count),
                    })),
                },
                monthlyPrecipitation,
                summerPrecipitation: seasonalPrecipitation.summerPrecipitation,
                winterPrecipitation: seasonalPrecipitation.winterPrecipitation,
            };
        };

        var parseAbiskoIceData = function (result) {
            var fields = result.meta.fields;
            var data = result.data;

            var iceData = [];

            data.forEach((row) => {
                var winterYear = +row[fields[0]] || undefined;
                var springYear = +row[fields[1]] || undefined;
                var freezeDate = parseDate(row[fields[2]]);
                var freezeWeek = freezeDate.year > 0 ? weekNumber(createDate(freezeDate)) : null;
                var freezeDOY = freezeDate.year > 0 ? dayOfYear(createDate(freezeDate)) : null
                var breakupDate = parseDate(row[fields[3]]);
                var breakupWeek = breakupDate.year > 0 ? weekNumber(createDate(breakupDate)) : null;
                var breakupDOY = breakupDate.year > 0 ? dayOfYear(createDate(breakupDate)) : null
                var iceTime = validNumber(row[fields[4]]) || null;

                if (winterYear) {
                    iceData[winterYear] = {
                        breakupDate: breakupDate.year > 0 ? createDate(breakupDate) : null,
                        breakupDOY,
                        breakupWeek,
                        freezeDate: freezeDate.year > 0 ? createDate(freezeDate) : null,
                        freezeDOY: freezeDOY + (freezeDOY < 50 ? 365 : 0),
                        freezeWeek: freezeWeek + (freezeWeek < 20 ? 52 : 0),
                        iceTime,
                    };
                }
            });

            var yearly = (statistic) => iceData.map((each, year) => ({
                x: +year,
                y: each[statistic],
            })).filter(each => each.y).filter(each => each.x >= 1909);

            var breakupDOY = iceData.map((each, year) => ({
                x: +year,
                y: each.breakupDOY,
                name: each.breakupDate ? monthName(monthByIndex(each.breakupDate.getMonth())) + ' ' + (+each.breakupDate.getDay() + 1) : null,
            })).filter(each => each.y).filter(each => each.x >= 1909);

            var freezeDOY = iceData.map((each, year) => ({
                x: +year,
                y: each.freezeDOY,
                name: each.freezeDate ? monthName(monthByIndex(each.freezeDate.getMonth())) + ' ' + (+each.freezeDate.getDay() + 1) : null,
            })).filter(each => each.y).filter(each => each.x >= 1909);;

            var breakupLinear = linearRegression(breakupDOY.map(w => w.x), breakupDOY.map(w => w.y));
            var freezeLinear = linearRegression(freezeDOY.map(w => w.x), freezeDOY.map(w => w.y));

            var breakup = breakupDOY.map(each => ({
                x: each.x,
                y: weekNumber(dateFromDayOfYear(each.x, each.y)),
                name: each.name,
            }));

            var freeze = freezeDOY.map(each => {
                var weekNo = weekNumber(dateFromDayOfYear(each.x, each.y));
                return {
                    x: each.x,
                    y: weekNo + (weekNo < 10 ? 52 : 0),
                    name: each.name,
                }
            });

            var iceTime = yearly('iceTime');

            var calculateMovingAverages = (values) => movingAverages(values.map(v => v.y), 10).map((avg, i) => ({
                x: values[i].x, y: avg,
            })).slice(10);

            var iceTimeMovAvg = calculateMovingAverages(iceTime);
            var iceTimeLinear = linearRegression(iceTime.map(w => w.x), iceTime.map(w => w.y));
            var iceTimeMovAvgLinear = linearRegression(iceTimeMovAvg.map(w => w.x), iceTimeMovAvg.map(w => w.y));

            var yearMax = iceData.length - 1;

            return {
                yearMax,
                breakup,
                freeze,
                iceTime,
                iceTimeMovAvg,
                breakupLinear: [
                    { x: 1915, y: weekNumber(dateFromDayOfYear(1915, Math.round(breakupLinear(1915)))) },
                    { x: yearMax, y: weekNumber(dateFromDayOfYear(yearMax, Math.round(breakupLinear(yearMax)))) }
                ],
                freezeLinear: [
                    { x: 1909, y: weekNumber(dateFromDayOfYear(1909, Math.round(freezeLinear(1909)))) },
                    { x: yearMax, y: weekNumber(dateFromDayOfYear(yearMax, Math.round(freezeLinear(yearMax)))) }
                ],
                iceTimeLinear: [
                    { x: 1915, y: iceTimeLinear(1915) },
                    { x: yearMax, y: iceTimeLinear(yearMax) }
                ],
                iceTimeMovAvgLinear: [
                    { x: 1925, y: iceTimeMovAvgLinear(1925) },
                    { x: yearMax, y: iceTimeMovAvgLinear(yearMax) }
                ],
            };
        };

        var parseAbiskoSnowData = function (result) {
            var data = result.data;
            var fields = result.meta.fields;

            var snow = [];

            data.forEach((row) => {
                var date = parseDate(row[fields[0]]);
                var depthSingleStake = validNumber(row[fields[1]]);
                if (date.year && depthSingleStake) {
                    var year = snow[date.year] = snow[date.year] || [];
                    var month = year[date.month] = year[date.month] || { sum: 0, count: 0 };
                    month.sum += depthSingleStake;
                    month.count++;
                }
            });

            snow.forEach((year) => {
                for (var i = 1; i <= 12; i++) {
                    var m = year[i];
                    year[i] = m ? m.sum / m.count : null;
                }
            });

            var periods = [
                //{ start: 1913, end: 1930 },
                { start: 1931, end: 1960 },
                { start: 1961, end: 1990 },
                { start: 1991, end: Infinity },
                { start: -Infinity, end: Infinity },
            ];

            var decades = [
                //{ start: 1931, end: 1940, },
                //{ start: 1941, end: 1950, },
                //{ start: 1951, end: 1960, },
                { start: 1961, end: 1970, },
                { start: 1971, end: 1980, },
                { start: 1981, end: 1990, },
                { start: 1991, end: 2000, },
                { start: 2001, end: 2010, },
                { start: 2011, end: Infinity },
                { start: -Infinity, end: Infinity }, // entire period
            ];

            var periodMeans = {};
            var decadeMeans = {};

            var calculateMeans = (periods, periodMeans) => {
                periods.forEach((period) => {
                    var key = period.start === -Infinity ? 'allTime' : period.start.toString();
                    var means = periodMeans[key] = {
                        period,
                        means: [],
                    };
                    means.period.toString = () => {
                        var start = means.period.start,
                            end = means.period.end;
                        if (key === 'allTime') return 'Entire period';
                        return 'From ' + start + ' to ' + (end === Infinity ? 'present' : end);
                    };
                    snow.filter((_, year) => year >= period.start && year <= period.end).forEach((year) => {
                        year.forEach((depth, month) => {
                            if (depth) {
                                var m = means.means[month - 1] = means.means[month - 1] || { sum: 0, count: 0 };
                                m.sum += depth;
                                m.count++;
                            }
                        });
                    });
                    for (var i = 0; i < 12; i++) {
                        var m = means.means[i];
                        means.means[i] = m ? m.sum / m.count : NaN;
                    }
                });
            };

            calculateMeans(periods, periodMeans);
            calculateMeans(decades, decadeMeans);

            return {
                periodMeans,
                decadeMeans,
            };
        };

        /*****************/
        /* RENDER GRAPHS */
        /*****************/

        var renderTemperatureGraph = function (temperatures, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line',
                    zoomType: 'xy',
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Temperature [°C]'
                    },
                    plotLines: [{
                        value: 0,
                        color: 'rgb(204, 214, 235)',
                        width: 2,
                    }],
                    max: 2,
                    min: -3,
                    tickInterval: 1,
                    lineWidth: 1,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' °C',
                    valueDecimals: 2,
                },
                series: [{
                    name: 'Max',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#ff0000',
                    data: temperatures.max,
                    visible: false,
                }, {
                    name: 'Min',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#0000ff',
                    data: temperatures.min,
                    visible: false,
                }, {
                    name: 'Yearly average',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#888888',
                    data: temperatures.avg,
                    visible: false,
                }, {
                    name: 'Confidence interval',
                    type: 'arearange',
                    color: '#888888',
                    data: temperatures.ci,
                    zIndex: 0,
                    fillOpacity: 0.3,
                    lineWidth: 0,
                    states: { hover: { lineWidthPlus: 0 } },
                    marker: { enabled: false },
                    visible: false,
                }, {
                    name: 'Moving average',
                    color: '#888888',
                    marker: { enabled: false },
                    data: temperatures.movAvg,
                }, {
                    name: 'Confidence interval',
                    type: 'arearange',
                    color: '#7777ff',
                    data: temperatures.ciMovAvg,
                    zIndex: 0,
                    fillOpacity: 0.3,
                    lineWidth: 0,
                    states: { hover: { lineWidthPlus: 0 } },
                    marker: { enabled: false },
                }],
            });
        };

        var renderAbiskoTemperatureGraph = function (temperatures, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line',
                    zoomType: 'xy',
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Temperature [°C]'
                    },
                    plotLines: [{
                        value: 0,
                        color: 'rgb(204, 214, 235)',
                        width: 2,
                    }],
                    //max: 2,
                    //min: -3,
                    tickInterval: 1,
                    lineWidth: 1,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' °C',
                    valueDecimals: 2,
                },
                series: [{
                    name: 'Max',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#ff0000',
                    data: temperatures.max,
                    visible: false,
                }, {
                    name: 'Min',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#0000ff',
                    data: temperatures.min,
                    visible: false,
                }, {
                    name: 'Yearly average',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#888888',
                    data: temperatures.avg,
                    visible: true,
                }, {
                    name: 'Confidence interval',
                    type: 'arearange',
                    color: '#888888',
                    data: temperatures.ci,
                    zIndex: 0,
                    fillOpacity: 0.3,
                    lineWidth: 0,
                    states: { hover: { lineWidthPlus: 0 } },
                    marker: { enabled: false },
                    visible: false,
                }, {
                    name: 'Moving average',
                    color: '#888888',
                    marker: { enabled: false },
                    data: temperatures.movAvg,
                }, {
                    name: 'Confidence interval',
                    type: 'arearange',
                    color: '#7777ff',
                    data: temperatures.ciMovAvg,
                    zIndex: 0,
                    fillOpacity: 0.3,
                    lineWidth: 0,
                    states: { hover: { lineWidthPlus: 0 } },
                    marker: { enabled: false },
                    visible: false,
                }],
            });
        };

        var renderAbiskoMonthlyTemperatureGraph = function (temperatures, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line',
                    zoomType: 'xy',
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Temperature [°C]'
                    },
                    plotLines: [{
                        value: 0,
                        color: 'rgb(204, 214, 235)',
                        width: 2,
                    }],
                    //max: 2,
                    //min: -3,
                    tickInterval: 1,
                    lineWidth: 1,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' °C',
                    valueDecimals: 2,
                },
                series: [{
                    name: 'Max',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#ff0000',
                    data: temperatures.max,
                    visible: false,
                }, {
                    name: 'Min',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#0000ff',
                    data: temperatures.min,
                    visible: false,
                }, {
                    name: 'Monthly average',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#888888',
                    data: temperatures.avg,
                    visible: true,
                }, {
                    name: 'Moving average',
                    color: '#888888',
                    marker: { enabled: false },
                    data: temperatures.movAvg,
                }],
            });
        };

        var renderTemperatureDifferenceGraph = function (temperatures, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'column'
                },
                title: {
                    text: title,
                },
                subtitle: {
                    //text: 'Difference between yearly average and average for 1961-1990',
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                    plotBands: [{
                        color: 'rgb(245, 245, 245)',
                        from: baselineLower,
                        to: baselineUpper,
                    }],
                },
                yAxis: {
                    title: {
                        text: 'Temperature [°C]'
                    },
                    lineWidth: 1,
                    min: -2,
                    max: 3,
                    tickInterval: 1,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' °C',
                    valueDecimals: 2,
                },
                legend: {
                    enabled: false,
                },
                annotations: [{
                    labelOptions: {
                        barkgroundColor: 'red',
                        verticalAlign: 'top',
                    },
                    labels: [{
                        point: {
                            xAxis: 0,
                            yAxis: 0,
                            x: baselineLower + (baselineUpper - baselineLower) / 2,
                            y: 2.4,
                        },
                        text: 'Baseline',
                    }],
                }],
                series: [{
                    name: 'Difference',
                    data: temperatures,
                    color: 'red',
                    negativeColor: 'blue',
                }],
            });
        };

        var renderGrowingSeasonGraph = function (season, id) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line',
                    zoomType: 'xy',
                },
                title: {
                    text: 'Growing season',
                },
                subtitle: {
                    text: 'The maximum consecutive weeks with average temperature above freezing.',
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Weeks'
                    },
                    tickInterval: 1,
                    lineWidth: 1,
                },
                tooltip: {
                    shared: true,
                    valueDecimals: 0,
                },
                series: [{
                    name: 'Weeks',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#00aa00',
                    data: season.weeks,
                    visible: true,
                }, {
                    name: 'Moving average',
                    color: '#00aa00',
                    marker: { enabled: false },
                    data: season.movAvg,
                }],
            });
        }

        var renderPrecipitationDifferenceGraph = function (precipitation, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'column'
                },
                title: {
                    text: title,
                },
                subtitle: {
                    //text: 'Difference between yearly average and average for 1961-1990',
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                    plotBands: [{
                        color: 'rgb(245, 245, 245)',
                        from: baselineLower,
                        to: baselineUpper,
                    }],
                },
                yAxis: {
                    title: {
                        text: 'Precipitation [mm]'
                    },
                    lineWidth: 1,
                    //min: -2,
                    //max: 3,
                    tickInterval: 1,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' mm',
                    valueDecimals: 2,
                },
                legend: {
                    enabled: false,
                },
                annotations: [{
                    labelOptions: {
                        barkgroundColor: 'red',
                        verticalAlign: 'top',
                    },
                    labels: [{
                        point: {
                            xAxis: 0,
                            yAxis: 0,
                            x: baselineLower + (baselineUpper - baselineLower) / 2,
                            y: 100,
                        },
                        text: 'Baseline',
                    }],
                }],
                series: [{
                    name: 'Difference',
                    data: precipitation,
                    color: 'red',
                    negativeColor: 'blue',
                }],
            });
        };

        var renderYearlyPrecipitationGraph = function (precipitation, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line'
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Total precipitation [mm]'
                    },
                    lineWidth: 1,
                    floor: 0, // Precipitation can never be negative
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' mm',
                    valueDecimals: 0,
                    headerFormat: '<span style="font-size: 10px">{point.key}</span><br/>' +
                        '<span style="color: red">\u25CF</span> Linear regression: <b>' + precipitation.linear + '</b><br />' +
                        '<span style="color: white; visibility: hidden">\u25CF</span> Total precipitation: <b>{point.total:.0f} mm</b><br />',
                },
                series: [{
                    name: 'Precipitation from snow',
                    type: 'column',
                    stack: 'precip',
                    stacking: 'normal',
                    data: precipitation.snow,
                    color: snowColor.color,
                    borderColor: snowColor.borderColor,
                    states: {
                        hover: {
                            color: snowColor.hover,
                            animation: {
                                duration: 0,
                            },
                        },
                    },
                }, {
                    name: 'Precipitation from rain',
                    type: 'column',
                    stack: 'precip',
                    stacking: 'normal',
                    data: precipitation.rain,
                    color: rainColor.color,
                    borderColor: rainColor.borderColor,
                    states: {
                        hover: {
                            color: rainColor.hover,
                            animation: {
                                duration: 0,
                            },
                        },
                    },
                }, {
                    name: 'Average precipitation',
                    color: precipColor,
                    data: precipitation.movAvg,
                }, {
                    name: 'Linear regression',
                    marker: {
                        enabled: false, // Linear regression lines doesn't contain points
                    },
                    color: 'red',
                    states: {
                        hover: {
                            lineWidth: 0, // Do nothing on hover
                        },
                    },
                    enableMouseTracking: false, // No interactivity
                    data: [
                        { x: precipitation.years[0], y: precipitation.linear(precipitation.years[0]) },
                        { x: precipitation.years[precipitation.years.length - 1], y: precipitation.linear(precipitation.years[precipitation.years.length - 1]) }
                    ],
                }],
            });
        };

        var renderMonthlyPrecipitationGraph = function (precipitation, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line'
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Total precipitation [mm]'
                    },
                    lineWidth: 1,
                    max: 150,
                    floor: 0, // Precipitation can never be negative
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' mm',
                    valueDecimals: 0,
                    headerFormat: '<span style="font-size: 10px">{point.key}</span><br/>' +
                        //'<span style="color: red">\u25CF</span> Linear regression: <b>' + precipitation.linear + '</b><br />' +
                        '<span style="color: white; visibility: hidden">\u25CF</span> Total precipitation: <b>{point.total:.0f} mm</b><br />',
                },
                series: [{
                    name: 'Precipitation from snow',
                    type: 'column',
                    stack: 'precip',
                    stacking: 'normal',
                    data: precipitation.snow,
                    color: snowColor.color,
                    borderColor: snowColor.borderColor,
                    states: {
                        hover: {
                            color: snowColor.hover,
                            animation: {
                                duration: 0,
                            },
                        },
                    },
                }, {
                    name: 'Precipitation from rain',
                    type: 'column',
                    stack: 'precip',
                    stacking: 'normal',
                    data: precipitation.rain,
                    color: rainColor.color,
                    borderColor: rainColor.borderColor,
                    states: {
                        hover: {
                            color: rainColor.hover,
                            animation: {
                                duration: 0,
                            },
                        },
                    },
                }, {
                    name: 'Average precipitation',
                    color: precipColor,
                    data: precipitation.movAvg,
                }],
            });
        };

        var renderAbiskoIceGraph = function (ice, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line'
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: [{
                    title: {
                        text: 'Ice break-up / freeze-up [day of year]',
                    },
                    lineWidth: 1,
                    labels: {
                        formatter: function () {
                            return this.value > 52 ? this.value - 52 : this.value;
                        },
                    }
                }, {
                    title: {
                        text: 'Ice time [number of days]',
                    },
                    lineWidth: 1,
                    max: 250,
                    min: 80,
                    opposite: true,
                }],
                tooltip: {
                    shared: true,
                    valueDecimals: 0,
                    pointFormat: '<span style="color:{point.color}">\u25CF</span> {series.name}: <b>{point.y}</b> {point.name}<br/>',
                },
                series: [{
                    yAxis: 0,
                    name: 'Freeze-up',
                    color: '#0000ee',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    data: ice.freeze,
                }, {
                    yAxis: 0,
                    name: 'Linear regression (freezing)',
                    marker: { enabled: false },
                    color: '#0000ee',
                    linkedTo: ':previous',
                    states: { hover: { lineWidth: 0, } },
                    enableMouseTracking: false,
                    data: ice.freezeLinear,
                }, {
                    yAxis: 0,
                    name: 'Break-up',
                    color: '#ee0000',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    data: ice.breakup,
                }, {
                    yAxis: 0,
                    name: 'Linear regression (breaking)',
                    marker: { enabled: false },
                    color: '#ee0000',
                    linkedTo: ':previous',
                    states: { hover: { lineWidth: 0, } },
                    enableMouseTracking: false,
                    data: ice.breakupLinear,
                }, {
                    yAxis: 1,
                    name: 'Ice time',
                    color: '#00bb00',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    data: ice.iceTime,
                }, {
                    yAxis: 1,
                    name: 'Linear regression (ice time)',
                    marker: { enabled: false },
                    color: '#00bb00',
                    linkedTo: ':previous',
                    states: { hover: { lineWidth: 0, } },
                    enableMouseTracking: false,
                    data: ice.iceTimeLinear,
                }, {
                    yAxis: 1,
                    name: 'Ice time (moving average)',
                    color: '#cc00cc',
                    data: ice.iceTimeMovAvg,
                }],
            });
        };

        var renderAbiskoSnowGraph = function (snow, id, title) {
            var series = Object.values(snow).map(p => ({
                name: p.period,
                data: p.means.rotate(6).slice(2),
            }));
            Highcharts.chart(id, {
                chart: {
                    type: 'line'
                },
                title: {
                    text: title,
                },
                xAxis: {
                    categories: months().rotate(6).slice(2),
                    title: {
                        text: 'Month',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Snow depth [cm]',
                    },
                    lineWidth: 1,
                    floor: 0,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' cm',
                    valueDecimals: 0,
                },
                series,
            });
        };

        /*****************************/
        /* LOADING DATA HAPPENS HERE */
        /*****************************/

        Papa.parse('data/NH.Ts downloaded 21062018.csv', {
            worker: useWebWorker,
            header: true,
            delimiter: ',',
            download: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            comments: 'Station',
            complete: function (result) {
                var temperatures = parseGISSTEMP(result);
                renderTemperatureGraph(temperatures, 'northernHemisphere', 'Northern Hemisphere temperatures');
            },
        });

        Papa.parse('data/GLB.Ts downloaded 21062018.csv', {
            worker: useWebWorker,
            header: true,
            delimiter: ',',
            download: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            comments: 'Station',
            complete: function (result) {
                var temperatures = parseGISSTEMP(result);
                renderTemperatureGraph(temperatures, 'globalTemperatures', 'Global temperatures');
            },
        });

        var parseZonal = function () {
            var cached;

            var complete = (result) => {
                if (cached) result = cached;
                else cached = result;
                var temperatures = parseGISSTEMPzonalMeans(result);
                renderTemperatureDifferenceGraph(temperatures['64n-90n'], 'temperatureDifference1', 'Temperature difference for Arctic (64N-90N)');
                renderTemperatureDifferenceGraph(temperatures['nhem'], 'temperatureDifference2', 'Temperature difference for Northern Hemisphere');
                renderTemperatureDifferenceGraph(temperatures['glob'], 'temperatureDifference3', 'Global temperature difference');
            }

            Papa.parse('data/ZonAnn.Ts+dSST downloaded 21062018.csv', {
                worker: useWebWorker,
                header: true,
                delimiter: ',',
                download: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete,
            });

            return complete;
        };
        parseZonal();

        var parseAbisko = function () {
            var cached;

            var complete = (result) => {
                if (cached) result = cached;
                else cached = result;
                var data = parseAbiskoCsv(result);
                var summerRange = monthName(summerMonths[0]) + ' to ' + monthName(summerMonths[summerMonths.length - 1]);
                var winterRange = monthName(winterMonths[0]) + ' to ' + monthName(winterMonths[winterMonths.length - 1]);
                renderAbiskoTemperatureGraph(data, 'AbiskoTemperatures', 'Abisko temperatures');
                renderAbiskoMonthlyTemperatureGraph(data.summerTemps, 'AbiskoTemperaturesSummer', 'Abisko temperatures for ' + summerRange);
                renderAbiskoMonthlyTemperatureGraph(data.winterTemps, 'AbiskoTemperaturesWinter', 'Abisko temperatures for ' + winterRange);
                months().forEach(month =>
                    renderAbiskoMonthlyTemperatureGraph(data.monthlyTemps[month], 'monthlyAbiskoTemperatures_' + month, 'Abisko temperatures for ' + monthName(month)));
                renderTemperatureDifferenceGraph(data.difference, 'temperatureDifferenceAbisko', 'Temperature difference for Abisko');

                renderGrowingSeasonGraph(data.growingSeason, 'growingSeason');

                renderYearlyPrecipitationGraph(data.yearlyPrecipitation, 'yearlyPrecipitation', 'Yearly precipitation');
                renderYearlyPrecipitationGraph(data.summerPrecipitation, 'summerPrecipitation', 'Precipitation for ' + summerRange);
                renderYearlyPrecipitationGraph(data.winterPrecipitation, 'winterPrecipitation', 'Precipitation for ' + winterRange);
                months().forEach(month =>
                    renderMonthlyPrecipitationGraph(data.monthlyPrecipitation[month], 'monthlyPrecipitation_' + month, 'Precipitation for ' + monthName(month)));

                renderPrecipitationDifferenceGraph(data.yearlyPrecipitation.difference, 'yearlyPrecipitationDifference', 'Precipitation difference');
                renderPrecipitationDifferenceGraph(data.summerPrecipitation.difference, 'summerPrecipitationDifference', 'Precipitation difference ' + summerRange);
                renderPrecipitationDifferenceGraph(data.winterPrecipitation.difference, 'winterPrecipitationDifference', 'Precipitation difference ' + winterRange);
            }

            Papa.parse('data/ANS_Temp_Prec_1913-2017.csv', {
                worker: useWebWorker,
                header: true,
                //delimiter: ';',
                download: true,
                skipEmptyLines: true,
                dynamicTyping: false,
                complete,
            });

            return complete;
        };
        parseAbisko();

        Papa.parse('data/Tornetrask_islaggning_islossning.csv', {
            worker: useWebWorker,
            header: true,
            download: true,
            skipEmptyLines: true,
            complete: (result) => {
                var data = parseAbiskoIceData(result);
                renderAbiskoIceGraph(data, 'abiskoLakeIce', 'Freeze-up and break-up of lake ice vs ice time');
            },
        });

        Papa.parse('data/ANS_SnowDepth_1913-2017.csv', {
            worker: useWebWorker,
            header: true,
            download: true,
            skipEmptyLines: true,
            complete: (result) => {
                var data = parseAbiskoSnowData(result);
                renderAbiskoSnowGraph(data.periodMeans, 'abiskoSnowDepthPeriodMeans', 'Monthly mean snow depth for Abisko');
                renderAbiskoSnowGraph(data.decadeMeans, 'abiskoSnowDepthPeriodMeans2', 'Monthly mean snow depth for Abisko');
            },
        });
    </script>
</body>

</html>